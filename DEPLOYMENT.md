# ECPOS File Upload to Vercel Blob - Deployment Guide

## Overview
This feature allows ECPOS Android app to upload files (BIR, DATABASE_BACKUPS, error_logs) to Vercel Blob storage through the middleware API.

---

## Prerequisites

1. **Vercel Account** - Create free account at [vercel.com](https://vercel.com)
2. **Vercel CLI** - Install globally: `npm install -g vercel`
3. **Node.js 22.x** - Already configured in package.json
4. **Vercel Blob Storage** - Enabled automatically on Vercel

---

## Step 1: Install Dependencies

Navigate to the middleware directory and install dependencies:

```bash
cd "D:\MARK ADS\fs-branch2\Mware-main\Mware-main"
npm install
```

This will install:
- `@vercel/blob` (v0.23.4) - Vercel Blob storage SDK
- All existing dependencies (express, multer, axios, etc.)

---

## Step 2: Deploy to Vercel

### Option A: Using Vercel CLI (Recommended)

1. **Login to Vercel:**
   ```bash
   vercel login
   ```

2. **Deploy:**
   ```bash
   vercel
   ```

3. **Follow the prompts:**
   - Link to existing project or create new one
   - Set up project settings
   - Wait for deployment to complete

4. **Deploy to Production:**
   ```bash
   vercel --prod
   ```

### Option B: Using Vercel Dashboard

1. Go to [vercel.com/dashboard](https://vercel.com/dashboard)
2. Click **"Add New Project"**
3. Import from Git (GitHub/GitLab/Bitbucket)
4. Or upload the project folder directly
5. Configure:
   - Framework Preset: **Other**
   - Build Command: `npm run build`
   - Output Directory: Leave empty
6. Click **"Deploy"**

---

## Step 3: Get Your Deployment URL

After deployment, Vercel will provide a URL like:
```
https://your-project-name.vercel.app
```

Or a custom domain if configured.

---

## Step 4: Configure Environment Variables (Important!)

### On Vercel Dashboard:

1. Go to your project settings
2. Navigate to **Environment Variables**
3. Add the following:

| Key | Value | Description |
|-----|-------|-------------|
| `BLOB_READ_WRITE_TOKEN` | (Auto-generated by Vercel) | Vercel Blob storage token |
| `API_BASE_URL` | `https://eljin.org/api` | Laravel backend URL |

**Note:** `BLOB_READ_WRITE_TOKEN` is automatically created by Vercel when you first use Blob storage.

---

## Step 5: Update Android App

Open `VercelUploadService.kt` and update the API URL:

```kotlin
companion object {
    private const val TAG = "VercelUploadService"
    // Replace with your actual Vercel URL
    private const val VERCEL_API_URL = "https://your-project-name.vercel.app/api/upload-files"
    private const val MAX_FILE_SIZE = 10 * 1024 * 1024 // 10MB
}
```

**Example:**
```kotlin
private const val VERCEL_API_URL = "https://ecpos-middleware.vercel.app/api/upload-files"
```

---

## Step 6: Test the Upload

### From Android App:

1. Build and install the updated APK
2. Go to **Settings** screen
3. Click **"ðŸ“¤ SHARE TO CLOUD"** button
4. Watch the progress dialog
5. Check for success message with Blob URL

### Expected Response:

```json
{
  "success": true,
  "message": "Files uploaded successfully to Vercel Blob",
  "data": {
    "url": "https://abc123xyz.public.blob.vercel-storage.com/STORE_2024-10-24.zip",
    "filename": "BW_SUPERBAKESHOP_STORE001_2024-10-24T12-30-45.zip",
    "size": 1048576,
    "uploadedAt": "2024-10-24T12:30:45.123Z",
    "storeId": "STORE001",
    "storeName": "BW SUPERBAKESHOP"
  }
}
```

---

## API Endpoints

### 1. Upload Files
**POST** `/api/upload-files`

**Request:**
- Content-Type: `multipart/form-data`
- Fields:
  - `storeId` (string, required)
  - `storeName` (string, required)
  - `archive` (file, required) - ZIP file max 10MB

**Response (Success):**
```json
{
  "success": true,
  "message": "Files uploaded successfully to Vercel Blob",
  "data": {
    "url": "https://...",
    "filename": "...",
    "size": 0,
    "uploadedAt": "...",
    "storeId": "...",
    "storeName": "..."
  }
}
```

**Response (Error):**
```json
{
  "success": false,
  "message": "Error message",
  "error": "Detailed error"
}
```

### 2. List Uploaded Files (Optional)
**GET** `/api/uploaded-files`

**Response:**
```json
{
  "success": true,
  "count": 10,
  "files": [
    {
      "url": "https://...",
      "pathname": "...",
      "size": 1048576,
      "uploadedAt": "..."
    }
  ]
}
```

---

## How It Works

### Android App Side:

1. **Collects Files:**
   - Scans `/com.example.possystembw/files/` directory
   - Includes: `BIR/`, `DATABASE_BACKUPS/`, `error_logs/`

2. **Creates ZIP Archive:**
   - Compresses all files into single .zip
   - Adds manifest.txt with metadata
   - Max size: 10MB

3. **Uploads to Vercel:**
   - Uses OkHttp multipart request
   - Sends storeId, storeName, and archive file
   - Shows progress dialog

### Vercel Middleware Side:

1. **Receives Upload:**
   - Multer captures file in memory (max 10MB)
   - Validates storeId and storeName

2. **Uploads to Vercel Blob:**
   - Uses `@vercel/blob` SDK
   - Generates unique filename with timestamp
   - Sets public access
   - Returns blob URL

3. **Returns Response:**
   - Success: Blob URL and metadata
   - Error: Detailed error message

---

## File Structure

### Android App:
```
app/src/main/java/com/example/possystembw/
â”œâ”€â”€ network/
â”‚   â””â”€â”€ VercelUploadService.kt     # Upload service
â””â”€â”€ ui/
    â””â”€â”€ PrinterSettingsActivity.kt  # Share button handler
```

### Vercel Middleware:
```
Mware-main/
â”œâ”€â”€ index.js               # Main Express server with endpoints
â”œâ”€â”€ package.json           # Dependencies including @vercel/blob
â”œâ”€â”€ vercel.json           # Vercel configuration
â””â”€â”€ DEPLOYMENT.md         # This file
```

---

## Vercel Blob Storage

### Features:
- âœ… Unlimited bandwidth
- âœ… Global CDN distribution
- âœ… Automatic HTTPS
- âœ… Public or private access
- âœ… No file size limit (but we limit to 10MB for mobile)

### Free Tier Limits:
- **100 GB bandwidth** per month
- **Unlimited** file uploads
- **Automatic** scaling

### Storage Location:
All files are stored in Vercel Blob Storage and accessible via:
```
https://[hash].public.blob.vercel-storage.com/[filename]
```

---

## Troubleshooting

### Issue: "BLOB_READ_WRITE_TOKEN is not set"

**Solution:** The token is auto-generated. Just use Blob storage once and Vercel creates it.

### Issue: "File too large"

**Solution:**
- Check Android side: Files zipped should be < 10MB
- Check Vercel: Default is 10MB (can be increased in settings)

### Issue: "Upload failed: Network error"

**Solution:**
- Verify Vercel URL is correct in Android app
- Check internet connection on device
- Verify Vercel deployment is online

### Issue: "Archive file is required"

**Solution:**
- Verify files exist in `/files/` directory
- Check if ZIP creation succeeded
- Ensure multipart form-data is correct

---

## Monitoring & Logs

### View Logs on Vercel:

1. Go to your project dashboard
2. Click **"Deployments"**
3. Click on latest deployment
4. View **"Function Logs"**

You'll see:
```
ðŸ“¤ File upload request received
ðŸ“¦ File received: { filename: '...', size: '2.5 MB', ... }
â˜ï¸  Uploading to Vercel Blob...
âœ… Upload successful: https://...
```

### View Blob Storage:

1. Go to project dashboard
2. Click **"Storage"** tab
3. Select **"Blob"**
4. View all uploaded files with:
   - File name
   - Size
   - Upload date
   - URL
   - Download/Delete options

---

## Security Considerations

1. **File Size Limit:** 10MB enforced
2. **File Type:** Only .zip archives accepted
3. **Public Access:** Files are publicly accessible via URL
4. **No Authentication:** Currently no auth (add if needed)

### To Add Authentication (Optional):

Update middleware:
```javascript
app.post('/api/upload-files',
  verifyApiKey,  // Add middleware
  upload.single('archive'),
  async (req, res) => {
    // ...
  }
);
```

---

## Cost Estimate

For typical usage:
- **10 stores** uploading daily
- **5 MB per archive**
- **30 days per month**

**Total:**
- Storage: 10 Ã— 5 MB Ã— 30 = **1.5 GB**
- Bandwidth: ~3-5 GB per month
- Cost: **FREE** (well within free tier)

---

## Next Steps

1. âœ… Deploy middleware to Vercel
2. âœ… Get deployment URL
3. âœ… Update Android app with URL
4. âœ… Build and test
5. âœ… Monitor uploads in Vercel dashboard

---

## Support

For issues:
- Check Vercel Function Logs
- Check Android Logcat filtered by "VercelUploadService"
- Verify network connectivity
- Check file sizes

---

## Summary

This implementation provides:
- âœ… **Easy file sharing** from POS to cloud
- âœ… **Automatic backup** of critical files
- âœ… **Centralized storage** on Vercel Blob
- âœ… **Public URLs** for easy access
- âœ… **Progress tracking** in Android app
- âœ… **Error handling** at every step
- âœ… **Free hosting** on Vercel

Your files (BIR, DATABASE_BACKUPS, error_logs) are now automatically uploaded to Vercel Blob storage with a single button click!
